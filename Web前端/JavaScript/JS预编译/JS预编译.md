# 预编译

`JavaScript`预编译分为`全局预编译`和`局部预编译`。

`全局预编译`发生在页面加载时候完成。

`局部预编译`发生在函数执行的前一刻。

## 全局预编译

### 全局对象(Global Object)

在`node`环境中，会产生`global`对象。

在`浏览器`环境中，JS引擎会整合所有的`<script>`标签，产生`window`对象，即`全局对象(GO)`。

### 全局变量&全局函数

在`<script>`标签中声明的变量为`全局变量`，`全局变量`作为`window`对象的属性存在。

在`<script>`标签中声明的函数为`全局函数`，`全局函数`作为`window`对象的方法存在。

```javascript
var a = 16;

function b() {}

console.dir(window);
```

打印`window`对象可以看到`变量a`和`函数b`分别作为`window`对象的属性和方法。

![全局变量&全局函数](./JS预编译.assets/全局变量&全局函数.png)

### 全局预编译流程

1. 查找`变量声明`，将`变量名`作为`全局对象(GO)`的属性名，并赋值为`undefined`。

2. 查找`函数声明`，将`函数名`作为`全局对象(GO)`的属性名，并赋值为`function`。

```javascript
console.log(a); // undefined
var a = 16;
console.log(a); // 16

console.log(b); // f b()
var b = 17;
function b() {}
```

代码预编译及执行过程：

```
1. 产生全局对象(GO)。

2. 查找变量声明，将变量名a和变量名b作为全局对象(GO)的属性名，并赋值为undefined。

3. 查找函数声明，将函数名b作为全局对象(GO)的属性名，并赋值为function。因为属性名b已经存在，所以替换属性名b原本的值undefined为function。

4. 全局预编译结束，代码从上到下依次执行。
```

## 局部预编译

### 活动对象(Activation Object)

`活动对象(AO)`在函数调用时产生，在函数调用结束时销毁。

如果函数没有执行，就不会产生`活动对象(AO)`，则在函数中定义的`局部变量`和`局部函数`也不会存在，所以不能在函数外部访问函数内部声明的变量和函数。

### 局部变量&局部函数

在函数内部声明的变量称为`局部变量`，`局部变量`作为`活动对象(AO)`的属性存在。

在函数内部声明的函数称为`局部函数`，`局部函数`作为`活动对象(AO)`的方法存在。

```javascript
function a() {
  var b = 16;
  function c() {}
  c();
}

a();
```

函数执行时才产生`活动对象(AO)`，`变量b`和`函数c`分别作为`活动对象(AO)`的属性和方法。

![局部变量&局部函数](./JS预编译.assets/局部变量&局部函数.png)

### 局部预编译流程

1. 在函数调用时，为当前函数产生`活动对象(AO)`。

2. 查找`形参`和`变量声明`，将`形参`和`变量名`作为`活动对象(AO)`的属性名，并赋值为`undefined`。

3. `实参`的值替换`形参`的值。

4. 查找`函数声明`，将`函数名`作为`活动对象(AO)`的属性名，并赋值为`function`。

```javascript
function a(num) {
  console.log(num); // undefined
  console.log(b); // undefined
  var b = 16;
  console.log(b); // 16
  function c() {
    console.log(17) // 17
  }
  c();
}

a();
```

代码预编译及执行过程：

```
全局预编译：

1. 产生全局对象(GO)。

2. 查找变量声明，全局没有变量声明。

3. 查找函数声明，将函数名a作为全局对象(GO)的属性名，并赋值为function。

4. 全局预编译结束，代码从上到下依次执行。调用函数a()，产生局部对象(AO)。

局部预编译：

1. 查找形参和变量声明，将形参num和变量名b作为局部对象(AO)的属性名，并赋值为undefined。

2. 查找实参，因为a()没有传递实参，所以num的值仍然是undefined。

3. 查找函数声明，将函数名c作为局部对象(AO)的属性名，并赋值为function。

4. 局部预编译结束，代码从上到下依次执行。
```
